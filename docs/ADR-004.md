# ADR-004: Full MCP Tool Coverage Across CFA Agents

| Field       | Value                        |
|-------------|------------------------------|
| **Status**  | Accepted                     |
| **Date**    | 2026-02-14                   |
| **Authors** | Robert Fall                  |
| **Deciders**| Engineering / Architecture   |

---

## Context

The CFA agent system deploys 8 specialist agents (equity, credit, fixed-income, derivatives,
quant-risk, macro, ESG-regulatory, private-markets), each constructing domain-prefixed tool
names (e.g., `valuation_dcf_model`) that `tool-name-resolver.ts` translates to MCP-registered
names (e.g., `dcf_model`).

The corp-finance-mcp server exposes **215 tools** across 71 modules. The static `AGENT_TO_MCP`
map contained only **76 entries (35% coverage)**. This caused three compounding failures:

1. **139 MCP tools had no resolver mapping.** Agents constructing prefixed names for these
   tools received "tool not found" errors despite the tools being registered and functional.
2. **Entire tool modules were unreachable.** Modules including `insurance`, `pension`,
   `lease_accounting`, `crypto`, `behavioral`, `fpa`, `treasury`, `private_credit`,
   `offshore_structures`, `onshore_structures`, `jurisdiction`, and `wealth` had zero entries.
3. **Agent `think()` methods only referenced mapped tools.** Specialists never considered
   invoking unmapped tools, producing text-only analysis without computational backing.

### Coverage Gap by Agent

| Agent                  | Mapped | Available | Gap |
|------------------------|--------|-----------|-----|
| equity-analyst         | 7      | ~28       | 21  |
| credit-analyst         | 9      | ~32       | 23  |
| fixed-income-analyst   | 8      | ~26       | 18  |
| derivatives-analyst    | 6      | ~20       | 14  |
| quant-risk-analyst     | 10     | ~30       | 20  |
| macro-analyst          | 14     | ~34       | 20  |
| esg-regulatory-analyst | 12     | ~25       | 13  |
| private-markets-analyst| 15     | ~30       | 15  |
| **Total (deduplicated)** | **76** | **215** | **139** |

In the hierarchical-mesh topology, the chief-analyst routes queries to specialists. When a
specialist cannot invoke the right tool due to a missing mapping, the analysis chain fails
silently — producing an unbacked text response with no indication a tool call was dropped.

---

## Decision

Implement a **3-tier resolution strategy** in `tool-name-resolver.ts`, extend all 8 agent
`think()` methods to reference newly mapped tools, and update skill documentation.

### Tier 1: Exact Match (Unchanged)

If the agent-constructed name is already a valid MCP tool name, return it directly:
```typescript
if (availableTools?.has(agentName)) return agentName;
```

### Tier 2: Extended Static Map (76 -> 215 Entries)

Expand `AGENT_TO_MCP` to cover every MCP-registered tool. New domain modules added:

| Domain Module | Tools Added | Example Mapping |
|---------------|------------|-----------------|
| `insurance` | 4 | `insurance_pricing_actuarial` -> `actuarial_pricing` |
| `pension` | 3 | `pension_liability_valuation` -> `pension_valuation` |
| `lease_accounting` | 3 | `lease_classification_test` -> `lease_classification` |
| `crypto` | 4 | `crypto_token_valuation` -> `token_valuation` |
| `behavioral` | 3 | `behavioral_bias_detection` -> `bias_scorecard` |
| `fpa` | 5 | `fpa_budget_variance` -> `budget_variance` |
| `treasury` | 4 | `treasury_cash_forecast` -> `cash_forecasting` |
| `private_credit` | 4 | `private_credit_direct_lending` -> `direct_lending_model` |
| `offshore/onshore` | 6 | `offshore_entity_setup` -> `offshore_structure` |
| `jurisdiction` | 3 | `jurisdiction_comparison` -> `jurisdiction_analysis` |
| `wealth` | 4 | `wealth_estate_planning` -> `estate_plan` |
| *Existing gaps* | ~96 | Various across `portfolio`, `scenarios`, etc. |

### Tier 3: Prefix-Stripping Fallback (New)

A runtime fallback strips known domain prefixes and checks the remainder against the
available tools set, auto-resolving future tools without manual map updates:
```typescript
if (availableTools) {
  const prefixes = [
    'valuation_', 'credit_', 'fixed_income_', 'derivatives_',
    'quant_risk_', 'macro_economics_', 'esg_', 'pe_', 'venture_',
    'insurance_', 'pension_', 'crypto_', 'behavioral_', 'fpa_',
    'treasury_', 'private_credit_', 'offshore_', 'onshore_',
    // ... ~60 prefixes total, ordered by frequency
  ];
  for (const prefix of prefixes) {
    if (agentName.startsWith(prefix)) {
      const stripped = agentName.slice(prefix.length);
      if (availableTools.has(stripped)) return stripped;
    }
  }
}
```
The fallback logs a warning when activated, signaling that a static entry should be added.

### Agent `think()` Updates

Each specialist's `think()` method gains its full tool repertoire:

| Agent | Before | After | New Capabilities |
|-------|--------|-------|-----------------|
| equity-analyst | 7 | ~28 | FPA, behavioral, lease accounting |
| credit-analyst | 9 | ~32 | Private credit, insurance, full bank analytics |
| fixed-income-analyst | 8 | ~26 | Full repo, mortgage, municipal |
| derivatives-analyst | 6 | ~20 | Crypto derivatives, full structured products |
| quant-risk-analyst | 10 | ~30 | Full scenarios, portfolio, Monte Carlo variants |
| macro-analyst | 14 | ~34 | Treasury, full trade finance, jurisdiction |
| esg-regulatory-analyst | 12 | ~25 | Offshore/onshore structures, full substance |
| private-markets-analyst | 15 | ~30 | Full infrastructure, CLO, wealth |

Skill documentation under `.claude/skills/` updated with "Full Tool Inventory" per domain.

---

## Consequences

### Positive

- **100% tool coverage.** All 215 corp-finance-mcp tools reachable by at least one specialist.
- **No breaking changes.** Existing 76 map entries preserved. Tiers 1-2 unchanged.
- **Future-proof.** Tier 3 prefix fallback auto-resolves new tools following the naming
  convention. Manual map updates become optional (documentation) not required (functionality).
- **Agent reasoning quality.** Agents that produced text-only analysis now invoke the right
  MCP tools, yielding computationally backed findings with citations.
- **DDD compliance.** Extended map respects bounded contexts from `types/agents.ts`.

### Negative

- **Larger static map.** `tool-name-resolver.ts` grows from ~143 to ~400 lines (under the
  500-line project limit). The map is flat key-value data with no logic complexity.
- **Prefix list maintenance.** New domain prefixes must be added to the Tier 3 list. Missing
  a prefix only means the fallback skips it — no existing resolution breaks.
- **Resolution order dependency.** Static map (Tier 2) takes precedence over prefix-stripping
  (Tier 3). Developers must understand this order to debug unexpected mappings.

### Neutral

- **No runtime performance impact.** Tiers 1-2 are O(1) lookups. Tier 3 is O(P) with ~60
  prefixes, activated only on miss — and rarely after expanding to 215 entries.
- **No database or MCP server changes.** All changes within the agent package boundary.

---

## Alternatives Considered

### A. Pure Auto-Resolution (No Static Map)

Replace the static map with dynamic prefix-stripping and fuzzy matching.

**Rejected because**: The static map serves as human-readable documentation cross-referencing
agent concepts to MCP tool names. It also handles semantic mappings where stripping fails
(e.g., `quant_risk_var_calculation` -> `tail_risk_analysis`, not `var_calculation`). Pure
auto-resolution would silently break these non-obvious mappings.

### B. Agent-Specific Resolver Maps

Give each agent its own resolver file (e.g., `equity-resolver.ts`, `credit-resolver.ts`).

**Rejected because**: Creates 8 files with significant duplication. Shared tools (e.g.,
`credit_spreads` used by both credit and fixed-income agents) would be defined in multiple
files. A tool rename would require updating multiple resolvers. A single centralized map
with domain comments achieves the same organization without the maintenance burden.

### C. Dynamic MCP Tool Discovery at Startup

Query the MCP server's `tools/list` method at agent init and build the map dynamically.

**Rejected because**: Adds IPC round-trips at every agent startup. In the hierarchical-mesh
topology, the chief-analyst may spawn multiple specialists per query, each independently
querying the server. Dynamic discovery cannot handle semantic mappings without the same
static map it tries to eliminate. Tier 3 prefix-stripping captures the useful portion of
dynamic discovery without network overhead.

### D. Rename MCP Tools to Match Agent Conventions

Rename all 215 MCP tools to use domain-prefixed names, eliminating the resolver.

**Rejected because**: MCP tool names are the public API surface. External consumers (Claude
Desktop, other MCP clients) reference tools by registered names. Renaming would break all
existing configurations, skill docs, and saved workflows. The resolver decouples agent
internal naming from MCP external naming — this decoupling is a feature, not a bug.
