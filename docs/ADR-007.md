# ADR-007: MoE Expert Routing via SemanticRouter

**Status**: Accepted  
**Date**: 2025-02-15  
**Supersedes**: Static keyword routing in chief-analyst.ts

## Context

The CFA agent orchestrator routes user queries to 8 specialist agents (equity, credit, fixed-income, derivatives, quant-risk, macro, ESG-regulatory, private-markets). The original routing used static keyword matching:

1. `classifyIntent(query)` — substring matching on 23 domain patterns
2. `suggestAgents(domains)` — set intersection against `TOOL_MAPPINGS`
3. `inferAgentType(step)` — domain overlap scoring with hardcoded `equity-analyst` fallback

This is brittle: "What are the risk factors for Apple's stock?" matches "risk" → quant-risk-analyst, missing the equity context. Multi-word queries with ambiguous signals produce suboptimal routing.

## Decision

Replace static keyword routing with **Mixture of Experts (MoE) semantic routing** using `@ruvector/router`'s `SemanticRouter` (HNSW-backed vector search) and `agentic-flow/embeddings` (local ONNX model, all-MiniLM-L6-v2, 384 dimensions).

### Architecture

```
Query → ExpertRouter.route(query, topK)
         ├── Embed query via agentic-flow/embeddings (local, <10ms)
         ├── HNSW search against 8 agent intent vectors
         ├── Return top-K agents with similarity scores
         └── Fallback: classifyIntent() → suggestAgents() (static)
```

Each specialist agent is registered as a SemanticRouter "intent" with utterances derived from:
- `AGENT_DESCRIPTIONS[agentType]` — human-readable specialist description
- `DOMAIN_PATTERNS[domain]` keywords — for each domain in `TOOL_MAPPINGS[agentType]`

### Key Components

| Component | File | Role |
|-----------|------|------|
| `ExpertRouter` | `config/expert-router.ts` | Wraps SemanticRouter, lazy init, graceful fallback |
| `DOMAIN_PATTERNS` | `config/tool-mappings.ts` | Shared domain keywords (extracted from `classifyIntent`) |
| `routeQuery()` | `agents/chief-analyst.ts` | Semantic-first, static-fallback routing method |
| `createPlan(routedAgents?)` | `agents/chief-analyst.ts` | Accepts pre-routed agents |

### Resolution Chain

1. **ExpertRouter.route()** — semantic similarity via HNSW (free, local, <10ms)
2. **classifyIntent() → suggestAgents()** — static keyword fallback (free, <1ms)

## Consequences

### Positive
- **Better routing accuracy**: Semantic matching understands "risk factors for a stock" → equity + quant, not just quant
- **No API costs**: Uses agentic-flow's local ONNX embedding model (already loaded for company-resolver)
- **Fast**: <10ms per query after model warmup (~200ms first call)
- **Observable**: Routing scores emitted in events for debugging/learning
- **Backward compatible**: Static routing preserved as fallback; existing tests unaffected

### Negative
- **Intent centroid averaging**: SemanticRouter averages all utterance embeddings into a centroid. Very short keywords may dilute the centroid quality.

### Implementation Notes
- **NPX environment workaround**: agentic-flow's embeddings module detects NPX environments and falls back to hash-based (non-semantic) embeddings. ExpertRouter sets `FORCE_TRANSFORMERS=1` before importing to force ONNX model loading.
- **CJS/ESM import**: `@ruvector/router` exports `SemanticRouter` under `default.SemanticRouter` (CJS-in-ESM wrapping). The import uses `(mod.default?.SemanticRouter ?? mod.SemanticRouter)` for compatibility.
- **Threshold delegation**: Score filtering is handled by SemanticRouter's constructor threshold — ExpertRouter passes results through without additional filtering.
- **Test mocking**: In CI/test environments without ONNX runtime, tests mock the router internals directly. The fallback to static routing is also covered.

### Neutral
- The 23 `DOMAIN_PATTERNS` keyword lists are now shared between the static classifier and the semantic router (extracted to `tool-mappings.ts`).
- `AnalystAssignment` gains an optional `routingScore` field for observability.

## Dependencies

- `@ruvector/router` (already in node_modules via ruvector)
- `agentic-flow/embeddings` (already used by company-resolver)
