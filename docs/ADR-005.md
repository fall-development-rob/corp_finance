# ADR-005: FMP Market Data Pipeline

| Field       | Value                        |
|-------------|------------------------------|
| **Status**  | Accepted                     |
| **Date**    | 2026-02-14                   |
| **Deciders**| CFA Agent Team               |
| **Supersedes** | —                         |
| **Relates to** | ADR-004 (Full Tool Coverage) |

---

## Context

CFA agents have access to 215 analytical tools (via corp-finance-mcp) and 181 market data tools
(via fmp-mcp-server), but these two systems operate in isolation. When a user asks "Analyze
Apple's credit risk", the agent:

1. Extracts metrics from the task text via regex (`parseFinancialData`)
2. Falls back to hardcoded defaults when the user doesn't provide numbers (e.g., `m.revenue ?? 1e9`)
3. Runs analytical tools with these defaults, producing generic rather than company-specific results

The agents function as calculators waiting for manual input rather than analysts capable of
independent research.

### The Gap

| Component        | Available              | Connected              |
|------------------|------------------------|------------------------|
| Analytical tools | 215 (corp-finance-mcp) | Yes                    |
| Market data tools| 181 (fmp-mcp-server)   | No (Pipeline A)        |
| Data flow        | —                      | Missing                |

Pipeline B (agentic-flow LLM path) already has FMP access via injected skill docs, but
Pipeline A (the programmatic BaseAnalyst path) has no way to fetch live data.

---

## Decision

Add a **data pipeline** that auto-fetches live financials from FMP before running analytical
tools. The pipeline inserts between text parsing and the reasoning loop:

### Architecture

```
parseFinancialData(task)  →  resolveSymbol()  →  fetchMarketData()  →  mapFmpToMetrics()  →  mergeMetrics()  →  think() + buildToolParams()
        ↑ regex                 ↑ FMP search        ↑ 6 parallel calls       ↑ field mapping        ↑ text wins          ↑ real data
```

### Components

1. **FmpBridge** (`bridge/fmp-bridge.ts`) — MCP client for the FMP server, mirrors McpBridge
2. **FMP Data Fetcher** (`utils/fmp-data-fetcher.ts`) — Core pipeline:
   - `resolveSymbol()` — Company name → ticker via `fmp_search_name`
   - `fetchMarketData()` — 6 parallel FMP calls (income, balance sheet, cash flow, metrics, profile, quote)
   - `mapFmpToMetrics()` — FMP JSON fields → `ExtractedMetrics` interface
   - `mergeMetrics()` — Text-parsed values override FMP (explicit user input wins)
   - `enrichMetrics()` — Full pipeline with graceful fallback
3. **Extended AnalystContext** — `callFmpTool` added alongside `callTool`
4. **BaseAnalyst prefetch** — Calls `enrichMetrics()` before the reasoning loop

### Merge Strategy

Text-parsed metrics always take priority over FMP data. If a user says "Analyze Apple,
revenue $500B", the explicit $500B overrides FMP's actual revenue. FMP fills all gaps the
user didn't specify.

### Graceful Degradation

The pipeline is fully fault-tolerant:
- No FMP API key → agents use text-only metrics (existing behavior)
- FMP server not running → agents use text-only metrics
- Individual FMP call fails → other fields still populate (Promise.allSettled)
- Symbol resolution fails → agents use text-only metrics
- No company name in query → agents use text-only metrics

---

## Consequences

### Positive

- **Company-specific analysis.** Agents produce company-specific analysis from just a
  name/ticker — no manual data entry.
- **Automatic data flow.** All 215 analytical tools automatically receive real financial data
  via `buildToolParams()`.
- **Zero breaking changes.** `callFmpTool` is optional, existing behavior preserved.
- **Low latency.** ~300ms for 6 parallel FMP calls (cached after first call).

### Negative

- **API key requirement.** Requires `FMP_API_KEY` environment variable for live data.
- **Additional process.** Adds second MCP server process alongside corp-finance-mcp.
- **Rate limits.** FMP free tier has rate limits (250 calls/day); may need paid tier for
  heavy use.

### Neutral

- No changes to the 215 analytical tools or their Zod schemas.
- No changes to tool-name-resolver or tool-mappings (except adding 'fmp' domain).
- Pipeline B (agentic-flow LLM path) is unaffected.

---

## Alternatives Considered

### A. Direct HTTP Calls to FMP API (Skip MCP)

Rejected: duplicates the FMP client code already in fmp-mcp-server, loses caching/rate-limiting.

### B. Merge Both MCP Servers Into One

Rejected: violates separation of concerns, increases coupling, harder to deploy independently.

### C. Let Each Agent's think() Call FMP Tools

Rejected: duplicates fetch logic across 8 agents, wastes API calls on redundant data.

### D. Pre-Fetch All Data in the Orchestrator Before Routing

Rejected: orchestrator shouldn't know about data fetching — that's the analyst's responsibility.
