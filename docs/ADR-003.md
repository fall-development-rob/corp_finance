# ADR-003: Financial Modeling Prep (FMP) Integration — MCP Server, CLI, and Skill

| Field       | Value                        |
|-------------|------------------------------|
| **Status**  | Proposed                     |
| **Date**    | 2026-02-13                   |
| **Authors** | Robert Fall                  |
| **Deciders**| Engineering / Architecture   |

---

## Context

The CFA agent system currently computes financial metrics (DCF, WACC, credit metrics, etc.) via
corp-finance-mcp tools, but has no access to **real market data**. All inputs must be manually
provided by the user. This limits the agent's ability to perform autonomous financial research —
an equity analyst agent can compute a DCF model, but cannot look up the current share price,
pull the latest income statement, or fetch the risk-free rate without the user copy-pasting
those values into the prompt.

FMP (financialmodelingprep.com) provides a comprehensive REST API with:

- **70,000+ securities** coverage (equities, ETFs, crypto, forex, commodities)
- **Real-time and historical price data** (1-minute to daily intervals)
- **Full financial statements** (income statement, balance sheet, cash flow, TTM)
- **Analyst estimates**, price targets, earnings transcripts, grades
- **Economic data** (treasury rates, GDP, CPI, economic calendar)
- **SEC filings**, insider trading, institutional holdings
- **Company profiles**, screeners, sector/industry performance
- **Index constituents** (S&P 500, Nasdaq, Dow Jones)

API authentication is via `?apikey=` query parameter. The "stable" API base URL is
`https://financialmodelingprep.com/stable/`. The free tier provides limited access (5 requests
per minute, restricted endpoints); paid tiers offer higher rate limits (300 req/min) and full
endpoint access.

### Current Data Flow

Without FMP, the agent data flow requires the user to provide every input manually:

```
User provides all inputs manually
        ↓
  CFA Agent → SemanticRouter → Specialist Agent
                                    ↓
                            corp-finance-mcp (calculations only)
                                    ↓
                            Result (based on user-supplied data)
```

There is no programmatic path from "I want to analyze Apple" to "here are Apple's financials."
The user must look up the data externally, format it, and paste it into the prompt. This makes
multi-step research workflows (e.g., screen for undervalued stocks, pull their financials,
compute DCFs, rank by upside) impossible without extensive manual intervention.

### FMP API Surface

FMP organizes its endpoints under a stable versioned base URL. The endpoints relevant to the
CFA agent system fall into seven domains:

| Domain | Endpoint Count | Example Use Case |
|--------|---------------|------------------|
| Quotes | 3 | Get current price for DCF terminal value |
| Profiles | 4 | Company overview, peer comparison |
| Financials | 6 | Income/balance/cash-flow for 3-statement model |
| Earnings | 6 | Analyst estimates for earnings surprise analysis |
| Market Data | 5 | Historical prices for beta calculation |
| Search | 3 | Symbol lookup, stock screening |
| Economics | 3 | Treasury rates for risk-free rate in WACC |

---

## Decision

### Three Deliverables

We will build three components that integrate FMP data access into the CFA agent system:

1. **FMP MCP Server** (`packages/fmp-mcp-server/`)
2. **CLI Integration** (`packages/agents/src/cli.ts`)
3. **Skill Files** (`.claude/skills/fmp-market-data/` and `.claude/skills/fmp-research/`)

### 1. FMP MCP Server

A standalone MCP server following the exact same pattern as `packages/mcp-server/` (corp-finance-mcp).
Uses `@modelcontextprotocol/sdk`, Zod schemas for input validation, and Stdio transport. Exposes
~30 tools organized into 7 domains:

| Domain | Tools | FMP Endpoints |
|--------|-------|---------------|
| **Quotes** | `fmp_quote`, `fmp_batch_quote`, `fmp_quote_short` | `/stable/quote`, `/stable/batch-quote`, `/stable/quote-short` |
| **Profiles** | `fmp_company_profile`, `fmp_stock_peers`, `fmp_key_executives`, `fmp_market_cap` | `/stable/profile`, `/stable/stock-peers`, `/stable/key-executives`, `/stable/market-capitalization` |
| **Financials** | `fmp_income_statement`, `fmp_balance_sheet`, `fmp_cash_flow`, `fmp_income_ttm`, `fmp_key_metrics`, `fmp_financial_ratios` | `/stable/income-statement`, `/stable/balance-sheet-statement`, `/stable/cash-flow-statement`, `/stable/income-statement-ttm`, `/stable/key-metrics`, `/stable/ratios` |
| **Earnings** | `fmp_earnings`, `fmp_earnings_calendar`, `fmp_earnings_transcript`, `fmp_analyst_estimates`, `fmp_price_target`, `fmp_grades` | `/stable/earnings`, `/stable/earnings-calendar`, `/stable/earning-call-transcript`, `/stable/analyst-estimates`, `/stable/price-target-summary`, `/stable/grades` |
| **Market Data** | `fmp_historical_price`, `fmp_intraday_chart`, `fmp_sector_performance`, `fmp_industry_performance`, `fmp_index_constituents` | `/stable/historical-price-eod/full`, `/stable/historical-chart/{interval}`, `/stable/sector-performance-snapshot`, `/stable/industry-performance-snapshot`, `/stable/sp500-constituent` |
| **Search** | `fmp_search_symbol`, `fmp_search_name`, `fmp_stock_screener` | `/stable/search-symbol`, `/stable/search-name`, `/stable/company-screener` |
| **Economics** | `fmp_treasury_rates`, `fmp_economic_indicators`, `fmp_economic_calendar` | `/stable/treasury-rates`, `/stable/economic-indicators`, `/stable/economic-calendar` |

**Server entrypoint** (`src/index.ts`):

```typescript
const server = new McpServer({
  name: "fmp-mcp-server",
  version: "1.0.0",
});

registerQuoteTools(server);
registerProfileTools(server);
registerFinancialTools(server);
registerEarningsTools(server);
registerMarketDataTools(server);
registerSearchTools(server);
registerEconomicsTools(server);

const transport = new StdioServerTransport();
await server.connect(transport);
```

Each `registerXxxTools(server)` function follows the exact same pattern as corp-finance-mcp:
define Zod schemas for inputs, register the tool with a description, parse inputs, call the
`FmpClient`, and return structured JSON results.

### 2. CLI Integration

Add `--data-source fmp` flag to the CLI and `fmp_` tool prefix routing. When an agent invokes
a `fmp_*` tool, the CLI bridges the call to the FMP MCP server via the existing `McpBridge`
mechanism:

```
cfa analyze --data-source fmp "Analyze AAPL: pull financials, compute DCF"
```

The CLI spawns the FMP MCP server as a child process alongside the existing corp-finance-mcp
server, giving agents access to both computation and data retrieval tools simultaneously.

### 3. Skill Files

Two new skills that teach agents when and how to use FMP tools:

- **`.claude/skills/fmp-market-data/SKILL.md`** — Market data retrieval skill covering quotes,
  profiles, financials, earnings, and historical prices. Includes tool selection guidance
  (e.g., "use `fmp_quote` for current price, `fmp_historical_price` for time series").

- **`.claude/skills/fmp-research/SKILL.md`** — Research skill covering screener workflows,
  sector/industry analysis, economic data, and index constituents. Includes workflow templates
  (e.g., "screen -> profile -> financials -> compute -> rank").

### Architecture

```
User Query ──→ CFA Agent ──→ SemanticRouter
                                   │
                           Agent (e.g., equity-analyst)
                           ├── corp-finance-mcp (calculations)
                           │     Tools: dcf, wacc, credit_metrics, ...
                           │
                           └── fmp-mcp-server (market data)
                                 Tools: fmp_quote, fmp_income_statement, ...
                                        │
                                        ↓
                                 FmpClient (HTTP)
                                 ├── Rate limiter (token bucket)
                                 ├── Response cache (TTL-based)
                                 └── Error handler
                                        │
                                        ↓
                                 FMP REST API
                                 https://financialmodelingprep.com/stable/
```

The separation of concerns is deliberate: **corp-finance-mcp owns computation** (DCF models,
WACC, credit metrics, scenario analysis) while **fmp-mcp-server owns data retrieval** (prices,
financials, estimates, economic data). An equity analyst agent can call `fmp_income_statement`
to fetch Apple's revenue, then pass that revenue into `dcf_model` from corp-finance-mcp to
compute intrinsic value — all within a single agent turn.

### FMP Client Architecture

A single `FmpClient` class in `src/client.ts` handles all HTTP communication with the FMP API:

```
FmpClient
  ├── Constructor
  │     ├── API key from FMP_API_KEY environment variable (required)
  │     ├── Base URL from FMP_BASE_URL (default: https://financialmodelingprep.com/stable)
  │     └── Rate limit from FMP_RATE_LIMIT (default: 300 req/min)
  │
  ├── request(endpoint, params) → JSON
  │     ├── Append apikey to query params
  │     ├── Check rate limiter (token bucket, reject with 429 if exhausted)
  │     ├── Check cache (return cached if TTL not expired)
  │     ├── HTTP GET with 10-second timeout
  │     ├── Error mapping:
  │     │     ├── 401 → FmpAuthError ("Invalid API key")
  │     │     ├── 403 → FmpPlanError ("Endpoint not available on current plan")
  │     │     ├── 429 → FmpRateLimitError ("Rate limit exceeded, retry after N seconds")
  │     │     └── 5xx → FmpServerError ("FMP API unavailable")
  │     ├── Cache response with domain-specific TTL
  │     └── Return parsed JSON
  │
  └── Cache TTL Strategy
        ├── Quotes: 5 minutes (prices change frequently)
        ├── Financials: 1 hour (statements update quarterly)
        ├── Profiles: 24 hours (company info rarely changes)
        ├── Economics: 1 hour (rates update daily)
        └── Overridable via FMP_CACHE_TTL environment variable
```

**Rate Limiter**: Token bucket algorithm. Starts with `FMP_RATE_LIMIT` tokens (default 300),
refills at `FMP_RATE_LIMIT / 60` tokens per second. Each request consumes one token. When
the bucket is empty, the client throws `FmpRateLimitError` with a `retryAfter` field
indicating when the next token will be available.

**Response Cache**: In-memory `Map<string, { data: unknown; expiresAt: number }>`. Cache key
is the full URL (including query parameters minus the API key). Expired entries are lazily
evicted on access. No maximum size limit — the cache holds at most a few hundred entries
during a typical agent session and is cleared on process exit.

### MCP Tool Pattern

Every tool follows this structure, identical to the corp-finance-mcp pattern:

```typescript
export function registerQuoteTools(server: McpServer) {
  server.tool(
    "fmp_quote",
    "Get real-time quote for a stock symbol including price, change, volume, and market cap",
    { symbol: z.string().describe("Stock ticker symbol (e.g., AAPL, MSFT)") },
    async ({ symbol }) => {
      const client = FmpClient.getInstance();
      const result = await client.request(`/quote/${symbol}`);
      return {
        content: [{ type: "text", text: JSON.stringify(result, null, 2) }],
      };
    },
  );

  // ... additional quote tools
}
```

Common parameters across tools:

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `symbol` | `string` | — | Stock ticker (e.g., `AAPL`) |
| `period` | `"annual" \| "quarter"` | `"annual"` | Reporting period for financials |
| `limit` | `number` | `5` | Number of periods to return |
| `from` / `to` | `string` (YYYY-MM-DD) | — | Date range for historical data |

### Environment Variables

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `FMP_API_KEY` | Yes | — | FMP API key (from financialmodelingprep.com dashboard) |
| `FMP_BASE_URL` | No | `https://financialmodelingprep.com/stable` | API base URL override |
| `FMP_RATE_LIMIT` | No | `300` | Requests per minute (5 for free tier) |
| `FMP_CACHE_TTL` | No | — | Global cache TTL override in seconds |

If `FMP_API_KEY` is not set, the server will start but every tool call will return an error
message instructing the user to set the environment variable. This allows the server to be
registered in the MCP configuration without requiring the key at startup time.

### Files to Create / Modify

| File | Action | Approx. Lines | Description |
|------|--------|---------------|-------------|
| `packages/fmp-mcp-server/package.json` | CREATE | ~30 | Package manifest with MCP SDK and Zod dependencies |
| `packages/fmp-mcp-server/tsconfig.json` | CREATE | ~15 | TypeScript config extending root |
| `packages/fmp-mcp-server/src/index.ts` | CREATE | ~40 | Server entrypoint, registers all tool domains |
| `packages/fmp-mcp-server/src/client.ts` | CREATE | ~150 | `FmpClient` class with rate limiter, cache, error handling |
| `packages/fmp-mcp-server/src/cache.ts` | CREATE | ~60 | TTL-based in-memory cache implementation |
| `packages/fmp-mcp-server/src/schemas/quotes.ts` | CREATE | ~40 | Zod schemas for quote tool inputs |
| `packages/fmp-mcp-server/src/schemas/profiles.ts` | CREATE | ~50 | Zod schemas for profile tool inputs |
| `packages/fmp-mcp-server/src/schemas/financials.ts` | CREATE | ~60 | Zod schemas for financial statement tool inputs |
| `packages/fmp-mcp-server/src/schemas/earnings.ts` | CREATE | ~60 | Zod schemas for earnings tool inputs |
| `packages/fmp-mcp-server/src/schemas/market-data.ts` | CREATE | ~50 | Zod schemas for market data tool inputs |
| `packages/fmp-mcp-server/src/schemas/search.ts` | CREATE | ~40 | Zod schemas for search tool inputs |
| `packages/fmp-mcp-server/src/schemas/economics.ts` | CREATE | ~40 | Zod schemas for economics tool inputs |
| `packages/fmp-mcp-server/src/tools/quotes.ts` | CREATE | ~60 | Quote tools: `fmp_quote`, `fmp_batch_quote`, `fmp_quote_short` |
| `packages/fmp-mcp-server/src/tools/profiles.ts` | CREATE | ~70 | Profile tools: `fmp_company_profile`, `fmp_stock_peers`, etc. |
| `packages/fmp-mcp-server/src/tools/financials.ts` | CREATE | ~90 | Financial tools: income, balance sheet, cash flow, TTM, etc. |
| `packages/fmp-mcp-server/src/tools/earnings.ts` | CREATE | ~80 | Earnings tools: estimates, transcripts, targets, grades |
| `packages/fmp-mcp-server/src/tools/market-data.ts` | CREATE | ~70 | Market data tools: historical prices, sector perf, constituents |
| `packages/fmp-mcp-server/src/tools/search.ts` | CREATE | ~50 | Search tools: symbol search, name search, screener |
| `packages/fmp-mcp-server/src/tools/economics.ts` | CREATE | ~50 | Economics tools: treasury rates, indicators, calendar |
| `.claude/skills/fmp-market-data/SKILL.md` | CREATE | ~100 | Market data retrieval skill definition |
| `.claude/skills/fmp-research/SKILL.md` | CREATE | ~80 | Research workflow skill definition |
| `packages/agents/src/cli.ts` | MODIFY | +20 | Add `--data-source fmp` flag and FMP server spawning |

---

## Consequences

### Positive

- **Autonomous research**: Agents can independently look up real market data during analysis
  without requiring the user to manually provide every input value.
- **Equity analyst workflow**: The equity analyst can fetch current price, financials, and
  analyst consensus before computing a DCF — a complete research workflow in one prompt.
- **Credit analyst workflow**: The credit analyst can pull financial statements to compute
  leverage ratios, interest coverage, and Altman Z-score without manual data entry.
- **Macro analyst workflow**: The macro analyst can access treasury rates for WACC risk-free
  rate input and economic indicators for scenario construction.
- **Economic calendar integration**: Event-driven analysis becomes possible — agents can check
  upcoming earnings dates, FOMC meetings, and economic releases.
- **Screening workflows**: The stock screener enables systematic analysis — screen for stocks
  matching criteria, then run DCF on each result.
- **Separation of concerns**: corp-finance-mcp owns computation, fmp-mcp-server owns data
  retrieval. Each server can be developed, tested, and deployed independently.
- **Composability**: Agents can chain FMP data tools with corp-finance-mcp computation tools
  in a single turn, e.g., `fmp_treasury_rates` -> use rate as `risk_free_rate` in `wacc`.

### Negative

- **External API dependency**: FMP downtime directly affects agent capabilities. If the API
  is unreachable, data retrieval tools will fail and agents must fall back to asking the user
  for manual input.
- **API key management and cost**: Production use requires a paid FMP plan ($15-79/month).
  The API key must be securely stored and rotated. Multiple developers sharing a key will
  hit rate limits.
- **Rate limiting bottleneck**: At 300 req/min on paid plans (5 req/min on free), multi-agent
  parallel queries can exhaust the rate limit. A mesh topology with 4 agents each making
  10 calls in a turn would consume 40 requests — safe on paid, but 8x over the free limit.
- **Data freshness**: Cached data may be stale for real-time use cases. The 5-minute quote
  cache means an agent cannot react to price movements within that window. For research
  workflows this is acceptable; for trading signals it is not.
- **Free tier limitations**: The free tier restricts both rate limits and endpoint access,
  which may limit testing and development. Some tools (e.g., earnings transcripts, screener)
  may not be available on the free plan.
- **New dependency surface**: Adding a second MCP server increases the operational complexity.
  The CLI must manage two child processes, and failures in either server must be handled
  gracefully without affecting the other.

### Neutral

- **No breaking changes**: The FMP integration is purely additive. Existing agents and workflows
  continue to work exactly as before. FMP tools are only available when `--data-source fmp` is
  specified or the FMP MCP server is explicitly configured.
- **Cache is ephemeral**: The in-memory cache is not shared across processes and is lost on
  restart. This is acceptable for the current single-process agent model. If multi-process
  execution is needed later, a shared cache (Redis, SQLite) can replace the in-memory `Map`
  without changing the tool interface.
- **No database changes**: FMP integration does not touch the ruvector-postgres schema. All
  data flows through the MCP tool interface; nothing is persisted beyond the response cache.

---

## Alternatives Considered

### A. Alpha Vantage API

Use Alpha Vantage as the market data provider instead of FMP.

**Rejected because**: Alpha Vantage covers approximately 5,000 symbols compared to FMP's
70,000+. Rate limits are stricter (5 req/min on free, 75 req/min on premium — vs FMP's 300
req/min on paid). Financial statement coverage is less comprehensive: Alpha Vantage provides
income, balance sheet, and cash flow, but lacks TTM variants, key metrics, and financial
ratios as pre-computed endpoints. No screener, no earnings transcripts, no grades. The API
response format is also less consistent across endpoints.

### B. Yahoo Finance (Unofficial Scraping)

Use an unofficial Yahoo Finance library (e.g., `yahoo-finance2`) for market data.

**Rejected because**: There is no official Yahoo Finance API. All available libraries scrape
the Yahoo Finance website or use undocumented internal endpoints. This violates Yahoo's Terms
of Service and is subject to breaking changes without notice. Multiple popular Yahoo Finance
libraries have experienced outages lasting days when Yahoo changed their page structure. For
an agent system that needs reliable data access, an unofficial scraping dependency is an
unacceptable risk.

### C. Bloomberg Terminal API (BLPAPI)

Use Bloomberg's official API for institutional-grade market data.

**Rejected because**: Bloomberg Terminal access costs ~$24,000/year per seat. The BLPAPI
requires a running Bloomberg Terminal instance and is not available as a standalone REST API.
This is overkill for an agent prototype and would limit adoption to users with existing
Bloomberg subscriptions. If the CFA agent system moves to institutional production use,
Bloomberg integration can be added as a separate MCP server alongside FMP.

### D. Polygon.io

Use Polygon.io as the market data provider.

**Rejected because**: Polygon provides excellent real-time and historical market data, but
its financial statement coverage is limited compared to FMP. Polygon focuses on price data,
trades, and quotes rather than fundamental financial data. The starter plan ($29/month)
provides only delayed data; real-time requires the developer plan ($79/month). FMP provides
a more comprehensive dataset for fundamental analysis at comparable cost.

### E. Financial Datasets API (as in virattt/dexter)

Use the Financial Datasets API, as implemented in the open-source Dexter agent.

**Rejected because**: Financial Datasets has narrower coverage — fewer endpoints, fewer
symbols, and less comprehensive financial statement data. The API is newer and less
battle-tested than FMP. While Dexter demonstrates a viable pattern for agent-based financial
analysis, the underlying data API does not provide the breadth of data (screener, economic
indicators, earnings transcripts, sector performance) needed for the CFA agent system's
multi-domain specialist agents.

### F. Embed FMP Calls Directly in Agent Prompts (No MCP Server)

Instead of building an MCP server, teach agents to make HTTP requests directly via a
generic `fetch` tool.

**Rejected because**: This eliminates type safety (no Zod schema validation), caching,
rate limiting, and error handling. Every agent would need to know the FMP URL structure,
API key handling, and response parsing. Centralizing these concerns in an MCP server
follows the same pattern that works well for corp-finance-mcp and ensures consistent
behavior across all agents.
