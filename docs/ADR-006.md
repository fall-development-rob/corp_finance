# ADR-006: Batch Portfolio Analysis & Cross-Specialist Collaboration

| Field       | Value                        |
|-------------|------------------------------|
| **Status**  | Accepted                     |
| **Date**    | 2026-02-14                   |
| **Deciders**| CFA Agent Team               |
| **Supersedes** | —                         |
| **Relates to** | ADR-005 (FMP Data Pipeline) |

---

## Context

The CFA agent system currently operates in a single-query mode: one user query produces one
analysis report. Two capabilities are missing:

### 1. Batch Portfolio Analysis
When a portfolio manager asks "Compare credit risk across Apple, Microsoft, Tesla, and JPMorgan",
the system processes them sequentially through separate `orchestrator.analyze()` calls. There is
no parallel execution, no comparative output, and no cross-company insights.

### 2. Cross-Specialist Collaboration
Specialists execute in parallel but in isolation. When the credit analyst discovers Apple has
49x interest coverage (extremely strong), the equity analyst doesn't learn this during execution.
Each agent completes its own reasoning loop independently, missing opportunities for
cross-pollination of findings.

---

## Decision

### A. Batch Portfolio Analysis

Add a `BatchAnalyzer` class that accepts an array of companies, runs analyses in parallel,
and produces both individual reports and a comparative summary.

```
User: "Compare credit risk: Apple, Microsoft, Tesla, JPMorgan"
  → BatchAnalyzer.analyze(["Apple", "Microsoft", "Tesla", "JPMorgan"])
    → 4x parallel Orchestrator.analyze() (with concurrency limit)
    → ComparativeReport: ranking, heatmap, cross-company insights
```

#### Components

1. **BatchAnalyzer** (`orchestrator/batch-analyzer.ts`)
   - `analyze(companies: string[], query: string, options?)` → `BatchResult`
   - Concurrency control (default: 3 parallel analyses)
   - Progress callbacks for real-time status
   - Individual results + comparative summary

2. **ComparativeReporter** (`utils/comparative-reporter.ts`)
   - Takes N individual `AnalysisResult[]` sets
   - Produces ranking tables, metric comparisons, relative positioning
   - Highlights outliers and key differentiators

3. **CLI integration** (`src/cli.ts`)
   - `cfa analyze --batch "AAPL,MSFT,TSLA,JPM" "Compare credit risk"`
   - `cfa analyze --batch @portfolio.txt "Full analysis"`
   - REPL: `/batch AAPL,MSFT,TSLA "Compare valuations"`

### B. Cross-Specialist Collaboration

Add an `InsightBus` that allows specialists to broadcast findings mid-execution. Other
specialists receive these broadcasts and incorporate them into subsequent reasoning iterations.

```
Credit Analyst (iteration 1):
  → Discovers: interest_coverage = 49x (exceptionally strong)
  → Broadcasts: { type: 'finding', agent: 'credit', metric: 'interest_coverage', value: 49, signal: 'strong' }

Equity Analyst (iteration 2):
  → Receives broadcast → adjusts WACC downward (lower credit risk → lower cost of debt)
  → Incorporates into DCF model
```

#### Components

1. **InsightBus** (`collaboration/insight-bus.ts`)
   - Extends `SimpleEventBus` with typed insight events
   - `broadcast(insight: AgentInsight)` — publishes to all subscribers
   - `subscribe(agentId, callback)` — agents receive peer findings
   - `getInsights(filter?)` — query accumulated insights

2. **AgentInsight type** (`types/collaboration.ts`)
   - `sourceAgent: AgentType` — who discovered this
   - `insightType: 'finding' | 'risk' | 'opportunity' | 'metric'`
   - `content: string` — human-readable insight
   - `data: Record<string, unknown>` — structured data
   - `confidence: number` — how confident the source agent is
   - `timestamp: Date`

3. **BaseAnalyst integration** (`agents/base-analyst.ts`)
   - After each iteration's `reflect()`, broadcast top findings
   - Before each iteration's `think()`, check for peer insights
   - Peer insights added to `state.observations` for reasoning context

4. **Orchestrator wiring** (`orchestrator/coordinator.ts`)
   - Creates shared `InsightBus` per analysis request
   - Passes to each specialist via `AnalystContext`
   - Collects all insights for inclusion in final report

---

## Consequences

### Positive

- **Portfolio-level analysis.** Managers can compare N companies in a single command.
- **Richer specialist output.** Cross-agent insights produce more nuanced analysis.
- **Parallel execution.** Batch analyses run concurrently with configurable limits.
- **Zero breaking changes.** Both features are additive — existing single-query flow unchanged.

### Negative

- **Increased API usage.** Batch of N companies = N × specialist count API calls.
- **Timing sensitivity.** Collaboration requires agents to run concurrently, not sequentially.
- **Complexity.** InsightBus adds event-driven coupling between agents.

### Neutral

- No changes to MCP tool schemas or the FMP data pipeline.
- No changes to the 215 analytical tools.
- Pipeline B (agentic-flow LLM path) is unaffected.

---

## Alternatives Considered

### A. Use agentic-flow P2PSwarmV2 directly

Rejected: P2PSwarmV2 is designed for process-level distribution. Our agents run in-process
and share memory. A lightweight InsightBus is simpler and lower-latency.

### B. Sequential batch with post-hoc comparison

Rejected: loses the benefit of cross-company insights during analysis. Parallel execution
with shared InsightBus enables both speed and collaboration.

### C. Full swarm topology for each batch item

Rejected: over-engineered. The existing Orchestrator already handles single-company analysis
well. BatchAnalyzer just wraps N parallel orchestrator calls.
