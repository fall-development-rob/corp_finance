#!/bin/sh
# Pre-commit hook: Rust formatting and linting checks

set -e

echo "Running pre-commit checks..."

# Check if any Rust files are staged
rust_staged=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(rs)$' || true)
ts_staged=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx)$' || true)

if [ -n "$rust_staged" ]; then
    echo "[1/3] Checking Rust formatting..."
    if ! cargo fmt --all --check 2>/dev/null; then
        echo ""
        echo "ERROR: Rust formatting check failed."
        echo "  Run 'cargo fmt --all' to fix."
        echo ""
        exit 1
    fi

    echo "[2/3] Running Clippy lints..."
    if ! cargo clippy --workspace --all-features -- -D warnings 2>/dev/null; then
        echo ""
        echo "ERROR: Clippy found warnings/errors."
        echo "  Fix the issues above before committing."
        echo ""
        exit 1
    fi

    echo "[3/3] Running tests..."
    if ! cargo test --workspace --all-features 2>/dev/null; then
        echo ""
        echo "ERROR: Tests failed."
        echo "  Fix failing tests before committing."
        echo ""
        exit 1
    fi
fi

if [ -n "$ts_staged" ]; then
    echo "[TS] Checking TypeScript..."
    if [ -f packages/mcp-server/node_modules/.bin/tsc ]; then
        (cd packages/mcp-server && npx tsc --noEmit 2>/dev/null) || {
            echo ""
            echo "ERROR: TypeScript type check failed."
            echo ""
            exit 1
        }
    fi
fi

echo "All pre-commit checks passed."
